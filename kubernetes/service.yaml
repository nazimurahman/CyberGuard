# kubernetes/service.yaml
---
# API Service
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-api
  namespace: cyberguard
  labels:
    app: cyberguard
    component: api
    tier: backend
  annotations:
    # Load balancer annotations
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"  # AWS NLB
    service.beta.kubernetes.io/aws-load-balancer-internal: "false"
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:region:account:certificate/id"
    # Prometheus annotations
    prometheus.io/scrape: "true"
    prometheus.io/port: "8000"
spec:
  type: ClusterIP  # Internal service, exposed via Ingress/NGINX
  selector:
    app: cyberguard
    component: api
  ports:
  - name: http
    port: 8000  # Port exposed within cluster
    targetPort: 8000  # Port on the pod
    protocol: TCP
  - name: metrics
    port: 9090
    targetPort: 9090
    protocol: TCP
  # Session affinity for stateful connections
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800  # 3 hours
---
# Dashboard Service
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-dashboard
  namespace: cyberguard
  labels:
    app: cyberguard
    component: dashboard
    tier: frontend
spec:
  type: ClusterIP
  selector:
    app: cyberguard
    component: dashboard
  ports:
  - name: http
    port: 8080
    targetPort: 8080
    protocol: TCP
---
# Scanner Service
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-scanner
  namespace: cyberguard
  labels:
    app: cyberguard
    component: scanner
    tier: backend
spec:
  type: ClusterIP
  selector:
    app: cyberguard
    component: scanner
  ports:
  - name: http
    port: 9000
    targetPort: 9000
    protocol: TCP
  - name: websocket
    port: 9001
    targetPort: 9001
    protocol: TCP
---
# PostgreSQL Service
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-postgres
  namespace: cyberguard
  labels:
    app: cyberguard
    component: database
    tier: data
spec:
  type: ClusterIP
  selector:
    app: cyberguard
    component: postgres
  ports:
  - name: postgres
    port: 5432
    targetPort: 5432
    protocol: TCP
  # Headless service for StatefulSet DNS
  clusterIP: None  # Headless service for direct pod access
---
# Redis Service
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-redis
  namespace: cyberguard
  labels:
    app: cyberguard
    component: redis
    tier: cache
spec:
  type: ClusterIP
  selector:
    app: cyberguard
    component: redis
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
    protocol: TCP
---
# ChromaDB Service
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-chromadb
  namespace: cyberguard
  labels:
    app: cyberguard
    component: vectordb
    tier: data
spec:
  type: ClusterIP
  selector:
    app: cyberguard
    component: chromadb
  ports:
  - name: http
    port: 8000
    targetPort: 8000
    protocol: TCP
---
# RabbitMQ Service
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-rabbitmq
  namespace: cyberguard
  labels:
    app: cyberguard
    component: message-queue
    tier: infrastructure
spec:
  type: ClusterIP
  selector:
    app: cyberguard
    component: rabbitmq
  ports:
  - name: amqp
    port: 5672
    targetPort: 5672
    protocol: TCP
  - name: management
    port: 15672
    targetPort: 15672
    protocol: TCP
---
# Nginx Service (Load Balancer)
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-nginx
  namespace: cyberguard
  labels:
    app: cyberguard
    component: reverse-proxy
    tier: edge
  annotations:
    # AWS specific annotations
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:us-east-1:123456789012:certificate/abc123"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    # Health check annotations
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-healthy-threshold: "2"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold: "2"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval: "10"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout: "5"
spec:
  type: LoadBalancer  # External load balancer
  selector:
    app: cyberguard
    component: nginx
  ports:
  - name: http
    port: 80  # External port
    targetPort: 80  # Container port
    protocol: TCP
  - name: https
    port: 443
    targetPort: 443
    protocol: TCP
  # External traffic policy
  externalTrafficPolicy: Local  # Preserves client IP
  # Load balancer IP (optional)
  loadBalancerIP: "10.0.0.100"
  # Session affinity
  sessionAffinity: None
---
# Prometheus Service
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-prometheus
  namespace: cyberguard
  labels:
    app: cyberguard
    component: monitoring
    tier: observability
spec:
  type: ClusterIP
  selector:
    app: cyberguard
    component: prometheus
  ports:
  - name: http
    port: 9090
    targetPort: 9090
    protocol: TCP
---
# Grafana Service
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-grafana
  namespace: cyberguard
  labels:
    app: cyberguard
    component: grafana
    tier: observability
spec:
  type: ClusterIP
  selector:
    app: cyberguard
    component: grafana
  ports:
  - name: http
    port: 3000
    targetPort: 3000
    protocol: TCP
---
# Ingestor Service
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-ingestor
  namespace: cyberguard
  labels:
    app: cyberguard
    component: ingestor
    tier: backend
spec:
  type: ClusterIP
  selector:
    app: cyberguard
    component: ingestor
  ports:
  - name: http
    port: 8081
    targetPort: 8081
    protocol: TCP
---
# Headless Services for StatefulSets
apiVersion: v1
kind: Service
metadata:
  name: cyberguard-postgres-headless
  namespace: cyberguard
  labels:
    app: cyberguard
    component: database
    tier: data
spec:
  clusterIP: None  # Headless service
  selector:
    app: cyberguard
    component: postgres
  ports:
  - name: postgres
    port: 5432
    targetPort: 5432
    protocol: TCP
  publishNotReadyAddresses: true  # Publish not ready pods
---
# ExternalName Service for External Databases (if needed)
apiVersion: v1
kind: Service
metadata:
  name: external-database
  namespace: cyberguard
spec:
  type: ExternalName
  externalName: database.example.com  # External database hostname
  ports:
  - name: postgres
    port: 5432
    protocol: TCP